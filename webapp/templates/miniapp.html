<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
        />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
        <meta name="format-detection" content="telephone=no" />
        <title>{{.BotName}} Assistant</title>
        <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
        <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            // Configure Tailwind to recognize our custom theme classes
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            tg: {
                                primary: 'var(--tg-theme-bg-color)',
                                secondary: 'var(--tg-theme-secondary-bg-color)',
                                text: 'var(--tg-theme-text-color)',
                                hint: 'var(--tg-theme-hint-color)',
                                link: 'var(--tg-theme-link-color)',
                                button: 'var(--tg-theme-button-color)',
                                'button-text': 'var(--tg-theme-button-text-color)',
                                destructive: 'var(--tg-theme-destructive-text-color)',
                            },
                        },
                    },
                },
            }
        </script>
        <link rel="stylesheet" href="/assets/css/app.css?101" />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
            rel="stylesheet"
        />
    </head>
    <body class="bg-tg-primary text-tg-text font-sans">
        <div
            id="initial-loader"
            class="fixed inset-0 bg-tg-primary flex items-center justify-center z-50"
        >
            <div class="text-center">
                <div
                    class="w-12 h-12 border-3 border-tg-link border-t-transparent rounded-full animate-spin mx-auto mb-4"
                ></div>
                <div class="text-tg-hint text-lg">Loading {{.BotName}}...</div>
            </div>
        </div>

        <div id="app" class="h-screen flex flex-col overflow-hidden" v-cloak>
            <!-- Loading Screen -->
            <div v-if="loading" class="flex-1 flex items-center justify-center bg-tg-primary">
                <div class="text-center">
                    <div
                        class="w-8 h-8 border-2 border-tg-link border-t-transparent rounded-full animate-spin mx-auto mb-4"
                    ></div>
                    <div class="text-tg-hint">Loading...</div>
                </div>
            </div>

            <!-- Main App -->
            <div v-else class="flex-1 flex h-full overflow-hidden">
                <!-- Sidebar -->
                <div
                    class="fixed lg:relative z-50 lg:z-auto w-80 h-full bg-tg-secondary border-r border-white/10 dark:border-white/10 flex flex-col transform transition-transform duration-300 ease-in-out"
                    :class="
                        sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'
                    "
                >
                    <div
                        class="flex-shrink-0 px-2 border-b border-white/10 dark:border-white/10 bg-tg-secondary"
                    >
                        <div class="flex items-center justify-between mb-2">
                            <button
                                @click="sidebarOpen = false"
                                class="lg:hidden p-1 rounded-md hover:bg-tg-primary/10 text-tg-hint"
                            >
                                <i class="fas fa-times w-4 h-4"></i>
                            </button>
                        </div>
                        <button
                            @click="newThread()"
                            :disabled="creatingThread"
                            class="w-full bg-tg-button text-tg-button-text py-2 mb-2 px-4 rounded-lg font-medium hover:opacity-90 disabled:opacity-50 transition-opacity"
                        >
                            <i
                                class="fas"
                                :class="creatingThread ? 'fa-spinner fa-spin' : 'fa-plus'"
                            ></i>
                            [[ creatingThread ? 'Creating...' : 'New Thread' ]]
                        </button>
                    </div>

                    <!-- Scrollable Content -->
                    <div class="flex-1 overflow-y-auto scrollbar-thin">
                        <div class="p-2">
                            <!-- Active Threads -->
                            <div
                                v-for="thread in sortedThreads"
                                :key="thread.id"
                                class="group rounded-lg mb-2 p-3 cursor-pointer transition-all hover:bg-tg-primary/5"
                                :class="
                                    currentThreadId === thread.id
                                        ? 'bg-tg-link/10 border border-tg-link/20'
                                        : 'hover:bg-tg-primary/5'
                                "
                                @click="selectThread(thread.id)"
                            >
                                <div class="relative">
                                    <div
                                        v-if="thread.id"
                                        class="absolute top-0 right-0 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10"
                                    >
                                        <button
                                            @click.stop="
                                                editThreadTitle(thread.id, thread.title)
                                            "
                                            class="p-1.5 rounded hover:bg-tg-hint/20 transition-colors"
                                            title="Edit title"
                                        >
                                            <i class="fas fa-edit text-xs"></i>
                                        </button>
                                        <button
                                            @click.stop="archiveThread(thread.id)"
                                            class="p-1.5 rounded hover:bg-tg-hint/20 text-tg-hint transition-colors"
                                            title="Archive thread"
                                        >
                                            <i class="fas fa-archive text-xs"></i>
                                        </button>
                                        <button
                                            @click.stop="confirmDeleteThread(thread.id)"
                                            class="p-1.5 rounded hover:bg-red-500 text-tg-hint transition-colors"
                                            title="Delete thread"
                                        >
                                            <i class="fas fa-trash text-xs"></i>
                                        </button>
                                    </div>
                                    <div
                                        class="font-medium text-sm text-tg-text truncate pr-2 mb-1"
                                    >
                                        [[ thread.title ]]
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 text-xs text-tg-hint">
                                    <span
                                        >[[ thread.id === currentThreadId ? currentMessageCount
                                        : thread.message_count ]] messages</span
                                    >
                                    <span>•</span>
                                    <span>[[ formatDate(thread.updated_at) ]]</span>
                                    <span
                                        v-if="
                                            thread.total_input_tokens ||
                                            thread.total_output_tokens
                                        "
                                        >•</span
                                    >
                                    <span
                                        v-if="
                                            thread.total_input_tokens ||
                                            thread.total_output_tokens
                                        "
                                        class="text-tg-link"
                                    >
                                        <i class="fas fa-calculator text-xs"></i>
                                        [[ formatThreadTokens(thread) ]]
                                    </span>
                                </div>
                            </div>

                            <!-- Archived Threads -->
                            <div v-if="hasArchivedThreads" class="mt-4">
                                <button
                                    @click="toggleArchivedSection"
                                    class="w-full flex items-center gap-2 py-2 px-3 text-sm text-tg-hint hover:text-tg-text hover:bg-tg-primary/5 rounded-lg transition-all"
                                >
                                    <i
                                        :class="
                                            showArchivedSection
                                                ? 'fas fa-chevron-down'
                                                : 'fas fa-chevron-right'
                                        "
                                        class="text-xs"
                                    ></i>
                                    Archived Threads ([[ archivedThreads.length ]])
                                </button>

                                <div v-if="showArchivedSection" class="mt-2 space-y-2">
                                    <div
                                        v-for="thread in archivedThreads"
                                        :key="'archived-' + thread.id"
                                        class="group rounded-lg p-3 cursor-pointer transition-all hover:bg-tg-primary/5 opacity-75"
                                        :class="
                                            currentThreadId === thread.id
                                                ? 'bg-tg-link/10 border border-tg-link/20'
                                                : ''
                                        "
                                        @click="selectThread(thread.id)"
                                    >
                                        <div class="flex items-start gap-3">
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <div
                                                        class="font-medium text-sm text-tg-text truncate flex-1"
                                                    >
                                                        [[ thread.title ]]
                                                    </div>
                                                    <button
                                                        v-if="thread.id"
                                                        @click.stop="
                                                            editThreadTitle(
                                                                thread.id,
                                                                thread.title
                                                            )
                                                        "
                                                        class="opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-tg-hint/20 text-tg-hint hover:text-tg-text transition-all"
                                                        title="Edit title"
                                                    >
                                                        <i class="fas fa-edit text-xs"></i>
                                                    </button>
                                                </div>
                                                <div
                                                    class="flex items-center gap-2 text-xs text-tg-hint"
                                                >
                                                    <span
                                                        >[[ thread.id === currentThreadId ?
                                                        messageCount : thread.message_count ]]
                                                        messages</span
                                                    >
                                                    <span>•</span>
                                                    <span
                                                        >Archived [[
                                                        formatDate(thread.archived_at) ]]</span
                                                    >
                                                </div>
                                            </div>
                                            <div
                                                class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                            >
                                                <button
                                                    @click.stop="archiveThread(thread.id)"
                                                    class="p-1.5 rounded hover:bg-tg-hint/20 text-tg-hint hover:text-tg-text transition-colors"
                                                    title="Unarchive thread"
                                                >
                                                    <i class="fas fa-undo text-xs"></i>
                                                </button>
                                                <button
                                                    v-if="thread.id"
                                                    @click.stop="
                                                        confirmDeleteThread(thread.id)
                                                    "
                                                    class="p-1.5 rounded hover:bg-red-100 text-tg-hint hover:text-tg-destructive transition-colors"
                                                    title="Delete thread"
                                                >
                                                    <i class="fas fa-trash text-xs"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer (Fixed at Bottom) -->
                    <div
                        class="flex-shrink-0 h-[89px] px-4 flex items-center border-t border-white/10 dark:border-white/10 bg-tg-secondary"
                    >
                        <button
                            @click="showRoleManager = true"
                            class="w-full flex items-center justify-center gap-2 py-2.5 px-4 rounded-lg bg-tg-primary/5 hover:bg-tg-primary/10 text-tg-text transition-colors"
                        >
                            <i class="fas fa-user-tag"></i>
                            <span class="font-medium">Roles</span>
                        </button>
                    </div>
                </div>

                <!-- Mobile Sidebar Backdrop -->
                <div
                    v-if="sidebarOpen"
                    class="fixed inset-0 bg-black/50 z-40 lg:hidden"
                    @click="sidebarOpen = false"
                ></div>

                <!-- Main Content -->
                <div class="flex-1 flex flex-col min-w-0">
                    <!-- Header -->
                    <div
                        class="flex-shrink-0 bg-tg-primary border-b border-white/10 dark:border-white/10 px-4 py-2"
                    >
                        <div class="flex items-center gap-4">
                            <button
                                @click="sidebarOpen = !sidebarOpen"
                                class="lg:hidden p-2 rounded-lg hover:bg-tg-secondary text-tg-text"
                            >
                                <i class="fas fa-bars"></i>
                            </button>

                            <div
                                v-if="currentThreadId"
                                class="flex-1 flex items-center justify-between"
                            >
                                <!-- Show selectors for new threads with no messages -->
                                <div
                                    v-if="shouldShowRoleSelector"
                                    class="flex items-center gap-2 flex-1 mr-2"
                                >
                                    <div class="flex-1">
                                        <select
                                            v-model="threadSettings.model_name"
                                            @change="updateThreadSettings"
                                            class="w-full h-10 px-3 rounded-lg text-sm bg-tg-secondary border border-white/10 dark:border-white/10 text-tg-text focus:border-tg-link focus:outline-none focus:ring-2 focus:ring-tg-link/20"
                                        >
                                            <option
                                                v-for="model in models"
                                                :key="model.id"
                                                :value="model.id"
                                            >
                                                [[ model.name ]]
                                            </option>
                                        </select>
                                    </div>

                                    <div v-if="roles.length > 0" class="flex-1">
                                        <select
                                            v-model="threadSettings.role_id"
                                            @change="updateThreadSettings"
                                            class="w-full h-10 px-3 rounded-lg text-sm bg-tg-secondary border border-white/10 dark:border-white/10 text-tg-text focus:border-tg-link focus:outline-none focus:ring-2 focus:ring-tg-link/20"
                                        >
                                            <option :value="null">Default Role</option>
                                            <option
                                                v-for="role in roles"
                                                :key="role.id"
                                                :value="role.id"
                                            >
                                                [[ role.name ]]
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Show current settings badges after first message -->
                                <div v-else class="flex flex-wrap items-center gap-1.5 flex-1">
                                    <!-- Model selector button -->
                                    <button
                                        @click="showSettings = true"
                                        class="flex items-center gap-1 bg-tg-secondary px-2 sm:px-3 py-1.5 rounded-full text-xs sm:text-sm hover:bg-tg-hint/10 transition-colors"
                                        title="Click to change model"
                                    >
                                        <i class="fas fa-brain text-tg-link text-xs"></i>
                                        <span class="text-tg-text font-medium hidden sm:inline"
                                            >[[ threadSettings.model_name || 'No model'
                                            ]]</span
                                        >
                                        <span class="text-tg-text font-medium sm:hidden"
                                            >[[ (threadSettings.model_name ||
                                            'Model').substring(0, 8) ]]</span
                                        >
                                    </button>

                                    <!-- Role selector button - hidden on mobile -->
                                    <button
                                        v-if="threadSettings.role_id || roles.length > 0"
                                        @click="showSettings = true"
                                        class="hidden sm:flex items-center gap-1 bg-tg-secondary px-2 sm:px-3 py-1.5 rounded-full text-xs sm:text-sm hover:bg-tg-hint/10 transition-colors"
                                        title="Click to change role"
                                    >
                                        <i class="fas fa-user-tag text-tg-link text-xs"></i>
                                        <span class="text-tg-text font-medium hidden lg:inline"
                                            >[[ currentRoleName || 'Default Role' ]]</span
                                        >
                                    </button>

                                    <!-- Search tool -->
                                        <button
                                            @click="toggleTool('search')"
                                            class="flex items-center gap-0.5 px-2 sm:px-3 py-1.5 rounded-full text-xs sm:text-sm transition-all"
                                            :class="threadSettings.enabled_tools.includes('search') 
                                                ? 'bg-tg-link text-white' 
                                                : 'bg-tg-secondary text-tg-hint hover:text-tg-text hover:bg-tg-hint/10'">
                                            <i class="fas fa-search"></i>
                                            <span class="tool-text hidden lg:inline font-medium">Search</span>
                                        </button>

                                    <!-- Code tool -->
                                        <button
                                            @click="toggleTool('code')"
                                            class="flex items-center gap-0.5 px-2 sm:px-3 py-1.5 rounded-full text-xs sm:text-sm transition-all"
                                            :class="threadSettings.enabled_tools.includes('code') 
                                                ? 'bg-tg-link text-white' 
                                                : 'bg-tg-secondary text-tg-hint hover:text-tg-text hover:bg-tg-hint/10'">
                                            <i class="fas fa-code"></i>
                                            <span class="tool-text hidden lg:inline font-medium">Code</span>
                                        </button>

                                    <button
                                            @click="toggleTool('summary')"
                                            class="flex items-center gap-0.5 px-2 sm:px-3 py-1.5 rounded-full text-xs sm:text-sm transition-all"
                                            :class="threadSettings.enabled_tools.includes('summary') 
                                                ? 'bg-tg-link text-white' 
                                                : 'bg-tg-secondary text-tg-hint hover:text-tg-text hover:bg-tg-hint/10'">
                                            <i class="fas fa-file-alt"></i>
                                            <span class="tool-text hidden lg:inline font-medium">Summary</span>
                                        </button>
                                </div>

                                <!-- Thread settings button -->
                                <button
                                    @click="showSettings = true"
                                    class="p-2 rounded-lg hover:bg-tg-secondary text-tg-hint hover:text-tg-text transition-colors"
                                    title="Thread Settings"
                                >
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div
                        class="flex-1 overflow-y-auto scrollbar-thin pb-24"
                        ref="messagesContainer"
                        @click="dismissKeyboard"
                    >
                        <!-- Welcome message -->
                        <div
                            v-if="!currentThreadId"
                            class="flex-1 flex items-center justify-center p-8"
                        >
                            <div class="text-center max-w-md">
                                <h2 class="text-2xl font-bold text-tg-text mb-4">
                                    Welcome to {{.BotName}} Assistant
                                </h2>
                                <p class="text-tg-hint leading-relaxed">
                                    Create a new thread to start chatting, or select an
                                    existing thread from the sidebar.
                                </p>
                            </div>
                        </div>

                        <!-- Messages list -->
                        <div v-else class="p-4 space-y-4">
                            <div
                                v-for="message in messages"
                                :key="message.id"
                                class="flex gap-3"
                                :class="
                                    message.role === 'user'
                                        ? 'justify-end user'
                                        : 'justify-start assistant'
                                "
                            >
                                <!-- Assistant Avatar -->
                                <div
                                    v-if="message.role === 'assistant'"
                                    class="flex-shrink-0 w-8 h-8 rounded-full bg-tg-link flex items-center justify-center"
                                >
                                    <i class="fas fa-robot text-white text-sm"></i>
                                </div>

                                <!-- Message Content -->
                                <div
                                    class="max-w-[80%] lg:max-w-[70%] group"
                                    :class="message.role === 'user' ? 'order-first' : ''"
                                >
                                    <!-- Summary Header -->
                                    <div
                                        v-if="message.message_type === 'summary'"
                                        class="flex items-center gap-2 mb-2 text-sm text-tg-hint"
                                    >
                                        <i class="fas fa-compress-alt"></i>
                                        <span>Conversation Summary</span>
                                    </div>

                                    <!-- Message bubble with copy button -->
                                    <div
                                        class="relative rounded-2xl px-4 pt-3 pb-1"
                                        :class="
                                            message.role === 'user'
                                                ? 'bg-tg-link text-white ml-auto'
                                                : 'bg-tg-secondary text-tg-text'
                                        "
                                        :style="
                                            message.isStreaming && message.estimatedHeight
                                                ? { minHeight: message.estimatedHeight + 'px' }
                                                : {}
                                        "
                                    >
                                        <!-- Copy button -->
                                        <button
                                            @click="copyMessage(message.content)"
                                            class="absolute top-2 right-2 w-6 h-6 rounded opacity-0 group-hover:opacity-80 hover:opacity-100 transition-opacity flex items-center justify-center text-xs z-10 bg-white/20 hover:bg-white text-white hover:text-black"
                                            title="Copy message"
                                        >
                                            <i class="fas fa-copy"></i>
                                        </button>

                                        <!-- Image attachment -->
                                        <div v-if="message.image_data" class="mb-3">
                                            <img
                                                :src="message.image_data"
                                                :alt="message.image_name"
                                                class="max-w-full h-auto rounded-lg"
                                            />
                                        </div>

                                        <!-- Message text -->
                                        <div
                                            class="prose prose-sm break-words"
                                            :class="{
                                                'streaming-text': message.isStreaming,
                                                'text-white': message.role === 'user',
                                            }"
                                            v-html="
                                                message.formattedContent || message.content
                                            "
                                        ></div>

                                        <!-- Annotations display -->
                                        <div
                                            v-if="
                                                message.annotations &&
                                                message.annotations.length > 0
                                            "
                                        >
                                            <!-- URL Citations -->
                                            <div
                                                v-html="formatAnnotations(message.annotations)"
                                                class="pr-8"
                                                :class="
                                                    message.role === 'user'
                                                        ? 'text-white/70'
                                                        : 'text-tg-text/70'
                                                "
                                            ></div>

                                            <!-- File Citations -->
                                            <div
                                                v-if="
                                                    message.annotations.some(
                                                        a =>
                                                            a.type === 'file_citation' ||
                                                            a.type ===
                                                                'container_file_citation'
                                                    )
                                                "
                                                class="mt-3 pr-8"
                                            >
                                                <div
                                                    v-for="(
                                                        annotation, idx
                                                    ) in message.annotations.filter(
                                                        a =>
                                                            a.type === 'file_citation' ||
                                                            a.type ===
                                                                'container_file_citation'
                                                    )"
                                                    :key="idx"
                                                >
                                                    <!-- Image file -->
                                                    <div
                                                        v-if="
                                                            annotation.local_file_path &&
                                                            annotation.local_file_path.match(
                                                                /\.(png|jpg|jpeg|gif)$/i
                                                            )
                                                        "
                                                        class="annotation-image mb-2"
                                                    >
                                                        <img
                                                            :src="annotation.local_file_path"
                                                            :alt="
                                                                annotation.filename ||
                                                                'Generated image'
                                                            "
                                                            class="max-w-full h-auto rounded-lg cursor-pointer hover:opacity-90 transition-opacity border border-white/10"
                                                            @click="
                                                                viewImageFullscreen({
                                                                    annotation_url:
                                                                        annotation.local_file_path,
                                                                    annotation_filename:
                                                                        annotation.filename,
                                                                })
                                                            "
                                                            :title="
                                                                'Click to view ' +
                                                                (annotation.filename ||
                                                                    'image') +
                                                                ' in fullscreen'
                                                            "
                                                        />
                                                        <div
                                                            class="text-xs text-opacity-70 mt-1"
                                                            :class="
                                                                message.role === 'user'
                                                                    ? 'text-white'
                                                                    : 'text-tg-hint'
                                                            "
                                                        >
                                                            <i class="fas fa-image mr-1"></i>
                                                            [[ annotation.filename ||
                                                            'Generated image' ]]
                                                        </div>
                                                    </div>

                                                    <!-- Document/other file -->
                                                    <div
                                                        v-else-if="annotation.local_file_path"
                                                        class="annotation-file mb-2"
                                                    >
                                                        <a
                                                            :href="annotation.local_file_path"
                                                            :download="annotation.filename"
                                                            class="inline-flex items-center gap-2 px-3 py-2 rounded-lg transition-colors"
                                                            :class="
                                                                message.role === 'user'
                                                                    ? 'bg-white/20 hover:bg-white/30 text-white'
                                                                    : 'bg-tg-link/10 hover:bg-tg-link/20 text-tg-link'
                                                            "
                                                            :title="
                                                                'Download ' +
                                                                (annotation.filename || 'file')
                                                            "
                                                        >
                                                            <i class="fas fa-download"></i>
                                                            <span class="text-sm font-medium"
                                                                >[[ annotation.filename ||
                                                                'Download file' ]]</span
                                                            >
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Streaming indicator -->
                                        <div
                                            v-if="
                                                message.isStreaming &&
                                                (!message.content ||
                                                    message.content.length === 0)
                                            "
                                            class="typing-indicator mt-2"
                                        >
                                            <div class="typing-dot"></div>
                                            <div class="typing-dot"></div>
                                            <div class="typing-dot"></div>
                                        </div>
                                    </div>

                                    <!-- Message metadata -->
                                    <div
                                        class="flex items-center gap-2 mt-1 px-1 text-xs text-tg-hint"
                                        :class="
                                            message.role === 'user'
                                                ? 'justify-end'
                                                : 'justify-between'
                                        "
                                    >
                                        <!-- Time and stats on left for assistant, right for user -->
                                        <div class="flex items-center gap-2">
                                            <span>[[ formatTime(message.created_at) ]]</span>

                                            <span
                                                v-if="
                                                    message.role === 'assistant' &&
                                                    message.total_tokens
                                                "
                                            >
                                                <i class="fas fa-calculator text-xs"></i>
                                                [[ message.total_tokens ]] tokens
                                            </span>

                                            <span
                                                v-if="
                                                    message.role === 'assistant' &&
                                                    message.response_time_ms
                                                "
                                            >
                                                <i class="fas fa-clock text-xs"></i>
                                                [[ formatResponseTime(message.response_time_ms)
                                                ]]
                                            </span>

                                            <span
                                                v-if="
                                                    message.role === 'assistant' &&
                                                    message.model_used &&
                                                    message.model_used !==
                                                        threadSettings.model_name
                                                "
                                            >
                                                <i class="fas fa-robot text-xs"></i>
                                                [[ message.model_used ]]
                                            </span>

                                            <span
                                                v-if="!message.is_live"
                                                class="px-2 py-0.5 bg-tg-hint/20 rounded-full"
                                                >Archived</span
                                            >
                                        </div>

                                        <button
                                            @click="deleteMessage(message.id)"
                                            class="opacity-0 group-hover:opacity-60 hover:!opacity-100 transition-opacity text-red-400 hover:text-red-500"
                                            title="Delete message"
                                        >
                                            <i class="fas fa-trash text-xs"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- User Avatar -->
                                <div
                                    v-if="message.role === 'user'"
                                    class="flex-shrink-0 w-8 h-8 rounded-full bg-white text-gray-700 flex items-center justify-center"
                                >
                                    <i class="fas fa-user text-sm"></i>
                                </div>
                            </div>
                        </div>

                        <!-- <div v-else>
                            <div class="flex-1 flex items-center justify-center p-8">
                                <div class="text-center">
                                    <div
                                        class="w-8 h-8 border-2 border-tg-link border-t-transparent rounded-full animate-spin mx-auto mb-4"
                                    ></div>
                                    <div class="text-tg-hint">Loading messages...</div>
                                </div>
                            </div>
                        </div> -->
                    </div>

                    <!-- Input Area -->
                    <div
                        v-if="currentThreadId"
                        class="fixed bottom-0 left-0 lg:left-80 right-0 bg-tg-primary border-t border-white/10 dark:border-white/10 z-20"
                    >
                        <!-- Image attachment preview -->
                        <div v-if="attachedImage" class="p-4 pb-0">
                            <div
                                class="flex items-center gap-3 bg-tg-secondary rounded-lg p-3"
                            >
                                <img
                                    :src="attachedImage.preview"
                                    :alt="attachedImage.name"
                                    class="w-12 h-12 object-cover rounded-lg"
                                />
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-tg-text truncate">
                                        [[ attachedImage.name ]]
                                    </div>
                                    <div class="text-xs text-tg-hint">
                                        [[ formatFileSize(attachedImage.size) ]]
                                    </div>
                                </div>
                                <button
                                    @click="clearAttachedImage"
                                    class="p-1.5 rounded-lg hover:bg-tg-primary/10 text-tg-hint hover:text-tg-text transition-colors"
                                    title="Remove image"
                                >
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Input wrapper -->
                        <div
                            class="py-4 px-2 flex items-center gap-2 max-w-4xl mx-auto w-full"
                        >
                            <button
                                @click="selectImage"
                                class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center transition-colors"
                                :class="
                                    attachedImage
                                        ? 'bg-tg-link text-white'
                                        : 'bg-tg-secondary text-tg-hint hover:text-tg-text hover:bg-tg-hint/10'
                                "
                                title="Attach image"
                            >
                                <i class="fas fa-image"></i>
                            </button>

                            <div class="flex-1">
                                <textarea
                                    ref="messageInput"
                                    v-model="messageInput"
                                    @keydown="handleKeyDown"
                                    @touchstart.passive="onInputTouch"
                                    placeholder="Type your message..."
                                    class="w-full py-3 px-4 rounded-2xl bg-tg-secondary border border-white/10 dark:border-white/10 text-tg-text placeholder-tg-hint focus:border-tg-link focus:outline-none focus:ring-2 focus:ring-tg-link/20 resize-none min-h-[48px]"
                                    :disabled="sending"
                                    autocomplete="off"
                                    autocorrect="off"
                                    autocapitalize="sentences"
                                    spellcheck="true"
                                    rows="1"
                                    style="field-sizing: content; max-height: 120px"
                                ></textarea>
                            </div>

                            <button
                                @click="streaming ? stopStreaming() : sendMessage()"
                                :disabled="!canSendMessage && !canStopStreaming"
                                class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center transition-all"
                                :class="
                                    streaming
                                        ? 'bg-tg-destructive text-white hover:bg-red-600'
                                        : canSendMessage
                                        ? 'bg-tg-button text-tg-button-text hover:opacity-90'
                                        : 'bg-tg-hint/20 text-tg-hint cursor-not-allowed'
                                "
                                :title="streaming ? 'Stop generation' : 'Send message (Enter)'"
                            >
                                <i :class="sendButtonIcon"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Modal -->
            <div
                v-if="showSettings"
                class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"
                @click="showSettings = false"
            >
                <div
                    class="bg-tg-primary rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col"
                    @click.stop
                >
                    <div
                        class="flex-shrink-0 flex items-center justify-between p-6 border-b border-white/10 dark:border-white/10"
                    >
                        <h3 class="text-xl font-semibold text-tg-text">Thread Settings</h3>
                        <button
                            @click="showSettings = false"
                            class="p-2 rounded-lg hover:bg-tg-secondary text-tg-hint hover:text-tg-text transition-colors"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="p-6 overflow-y-auto">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-tg-text mb-2"
                                    >Model</label
                                >
                                <select
                                    v-model="threadSettings.model_name"
                                    class="w-full py-2.5 px-3 rounded-lg bg-tg-secondary border border-white/10 dark:border-white/10 text-tg-text focus:border-tg-link focus:outline-none focus:ring-2 focus:ring-tg-link/20"
                                >
                                    <option
                                        v-for="model in models"
                                        :key="model.id"
                                        :value="model.id"
                                    >
                                        [[ model.name ]] ([[ model.provider ]])
                                    </option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-tg-text mb-2">
                                    Temperature: [[ threadSettings.temperature ]]
                                </label>
                                <input
                                    type="range"
                                    v-model.number="threadSettings.temperature"
                                    min="0"
                                    max="1"
                                    step="0.1"
                                    class="slider-tg w-full"
                                />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-tg-text mb-2">
                                    Role ([[ roles.length ]] available)
                                </label>
                                <select
                                    v-model="threadSettings.role_id"
                                    class="w-full py-2.5 px-3 rounded-lg bg-tg-secondary border border-white/10 dark:border-white/10 text-tg-text focus:border-tg-link focus:outline-none focus:ring-2 focus:ring-tg-link/20"
                                >
                                    <option :value="null">No role</option>
                                    <option v-if="roles.length === 0" disabled>
                                        Loading roles...
                                    </option>
                                    <option
                                        v-for="role in roles"
                                        :key="role.id"
                                        :value="role.id"
                                    >
                                        [[ role.name ]]
                                    </option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-tg-text mb-2"
                                    >Context Limit</label
                                >
                                <input
                                    type="number"
                                    v-model.number="threadSettings.context_limit"
                                    min="1000"
                                    max="8000"
                                    step="500"
                                    class="w-full py-2.5 px-3 rounded-lg bg-tg-secondary border border-white/10 dark:border-white/10 text-tg-text placeholder-tg-hint focus:border-tg-link focus:outline-none focus:ring-2 focus:ring-tg-link/20 resize-none"
                                />
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex-shrink-0 p-6 border-t border-white/10 dark:border-white/10"
                    >
                        <button
                            @click="saveSettings"
                            class="w-full bg-tg-button text-tg-button-text py-2.5 px-4 rounded-lg font-medium hover:opacity-90 disabled:opacity-50 transition-opacity"
                        >
                            Save Settings
                        </button>
                    </div>
                </div>
            </div>

            <!-- Role Manager Modal -->
            <div
                v-if="showRoleManager"
                class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"
                @click="showRoleManager = false"
            >
                <div
                    class="bg-tg-primary rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col"
                    @click.stop
                >
                    <div
                        class="flex-shrink-0 flex items-center justify-between p-6 border-b border-white/10 dark:border-white/10"
                    >
                        <h3 class="text-xl font-semibold text-tg-text">Role Manager</h3>
                        <button
                            @click="showRoleManager = false"
                            class="p-2 rounded-lg hover:bg-tg-secondary text-tg-hint hover:text-tg-text transition-colors"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="p-6 overflow-y-auto">
                        <button
                            @click="newRole"
                            class="w-full bg-tg-button text-tg-button-text py-2.5 px-4 rounded-lg font-medium hover:opacity-90 disabled:opacity-50 transition-opacity"
                        >
                            <i class="fas fa-plus"></i>
                            New Role
                        </button>

                        <div class="space-y-4">
                            <div
                                v-for="role in roles"
                                :key="role.id"
                                class="bg-tg-secondary rounded-lg p-4"
                            >
                                <div class="flex items-start justify-between mb-3">
                                    <span class="font-semibold text-tg-text"
                                        >[[ role.name ]]</span
                                    >
                                    <div class="flex items-center gap-2">
                                        <button
                                            @click="editRole(role)"
                                            class="p-1.5 rounded hover:bg-tg-primary/10 text-tg-link hover:text-tg-text transition-colors"
                                        >
                                            <i class="fas fa-edit text-sm"></i>
                                        </button>
                                        <button
                                            @click="deleteRole(role.id)"
                                            class="p-1.5 rounded hover:bg-red-100 text-tg-hint hover:text-tg-destructive transition-colors"
                                        >
                                            <i class="fas fa-trash text-sm"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-sm text-tg-hint leading-relaxed">
                                    [[ role.prompt ]]
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Role Editor Modal -->
            <div
                v-if="showRoleEditor"
                class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"
                @click="showRoleEditor = false"
            >
                <div
                    class="bg-tg-primary rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col"
                    @click.stop
                >
                    <div
                        class="flex-shrink-0 flex items-center justify-between p-6 border-b border-white/10 dark:border-white/10"
                    >
                        <h3 class="text-xl font-semibold text-tg-text">
                            [[ editingRole?.id ? 'Edit Role' : 'New Role' ]]
                        </h3>
                        <button
                            @click="showRoleEditor = false"
                            class="p-2 rounded-lg hover:bg-tg-secondary text-tg-hint hover:text-tg-text transition-colors"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="p-6 overflow-y-auto">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-tg-text mb-2"
                                    >Role Name</label
                                >
                                <input
                                    type="text"
                                    v-model="editingRole.name"
                                    placeholder="Enter role name"
                                    class="w-full py-2.5 px-3 rounded-lg bg-tg-secondary border border-white/10 dark:border-white/10 text-tg-text placeholder-tg-hint focus:border-tg-link focus:outline-none focus:ring-2 focus:ring-tg-link/20 resize-none"
                                />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-tg-text mb-2"
                                    >System Prompt</label
                                >
                                <textarea
                                    v-model="editingRole.prompt"
                                    placeholder="Enter system prompt..."
                                    rows="6"
                                    class="w-full py-2.5 px-3 rounded-lg bg-tg-secondary border border-white/10 dark:border-white/10 text-tg-text placeholder-tg-hint focus:border-tg-link focus:outline-none focus:ring-2 focus:ring-tg-link/20 resize-none"
                                ></textarea>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex-shrink-0 p-6 border-t border-white/10 dark:border-white/10"
                    >
                        <button
                            @click="saveRole"
                            class="w-full bg-tg-button text-tg-button-text py-2.5 px-4 rounded-lg font-medium hover:opacity-90 disabled:opacity-50 transition-opacity"
                        >
                            [[ editingRole?.id ? 'Update Role' : 'Create Role' ]]
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit Thread Title Modal -->
            <div
                v-if="showEditTitle"
                class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"
                @click="showEditTitle = false"
            >
                <div
                    class="bg-tg-primary rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col"
                    @click.stop
                >
                    <div
                        class="flex-shrink-0 flex items-center justify-between p-6 border-b border-white/10 dark:border-white/10"
                    >
                        <h3 class="text-xl font-semibold text-tg-text">Edit Thread Title</h3>
                        <button
                            @click="showEditTitle = false"
                            class="p-2 rounded-lg hover:bg-tg-secondary text-tg-hint hover:text-tg-text transition-colors"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-tg-text mb-2"
                                    >Thread Title</label
                                >
                                <input
                                    type="text"
                                    v-model="editingTitle.title"
                                    placeholder="Enter thread title"
                                    class="w-full py-2.5 px-3 rounded-lg bg-tg-secondary border border-white/10 dark:border-white/10 text-tg-text placeholder-tg-hint focus:border-tg-link focus:outline-none focus:ring-2 focus:ring-tg-link/20"
                                    @keydown.enter="saveThreadTitle"
                                    @keydown.escape="showEditTitle = false"
                                    ref="editTitleInput"
                                />
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex-shrink-0 p-6 flex gap-3 border-t border-white/10 dark:border-white/10"
                    >
                        <button
                            @click="showEditTitle = false"
                            class="flex-1 py-2.5 px-4 rounded-lg bg-tg-secondary text-tg-text hover:bg-tg-hint/20 transition-colors font-medium"
                        >
                            Cancel
                        </button>
                        <button
                            @click="saveThreadTitle"
                            :disabled="!editingTitle.title.trim() || savingTitle"
                            class="flex-1 py-2.5 px-4 rounded-lg bg-tg-button text-tg-button-text hover:opacity-90 disabled:opacity-50 transition-opacity font-medium"
                        >
                            <i v-if="savingTitle" class="fas fa-spinner fa-spin mr-2"></i>
                            [[ savingTitle ? 'Saving...' : 'Save' ]]
                        </button>
                    </div>
                </div>
            </div>

            <!-- Fullscreen Image Viewer Modal -->
            <div
                v-if="fullscreenImage"
                class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"
                @click="closeFullscreenImage"
            >
                <div class="relative max-w-[90vw] max-h-[90vh] flex flex-col" @click.stop>
                    <!-- Image -->
                    <img
                        :src="fullscreenImage.src"
                        :alt="fullscreenImage.filename"
                        class="max-w-full max-h-[80vh] object-contain rounded-lg shadow-2xl"
                    />

                    <!-- Image info and close button -->
                    <div
                        class="flex items-center justify-between mt-4 px-4 py-3 bg-black/50 rounded-lg"
                    >
                        <div class="text-white">
                            <div class="font-medium">[[ fullscreenImage.filename ]]</div>
                            <div class="text-sm text-white/70">Code Interpreter Output</div>
                        </div>
                        <button
                            @click="closeFullscreenImage"
                            class="p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white transition-colors"
                            title="Close (ESC)"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Download link -->
                    <a
                        :href="fullscreenImage.src"
                        :download="fullscreenImage.filename"
                        class="mt-2 inline-flex items-center justify-center gap-2 px-4 py-2 bg-tg-button text-tg-button-text rounded-lg hover:opacity-90 transition-opacity"
                    >
                        <i class="fas fa-download"></i>
                        Download Image
                    </a>
                </div>
            </div>
        </div>

        <script src="/assets/js/app.js?102"></script>
    </body>
</html>
