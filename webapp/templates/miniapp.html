<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>{{.BotName}} Assistant</title>
    <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <link rel="stylesheet" href="/assets/css/app.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div id="app">
        <div v-if="loading" class="loading-container">
            <div class="loading-spinner"></div>
            <div>Loading...</div>
        </div>

        <!-- Main App -->
        <div v-else class="app-container">
            <div class="sidebar" :class="{ 'sidebar-open': sidebarOpen }">
                <div class="sidebar-header">
                    <div class="sidebar-header-top">
                        <h3>Threads</h3>
                        <button @click="sidebarOpen = false" class="close-sidebar-btn" title="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <button @click="newThread()" class="new-thread-btn">
                        <i class="fas fa-plus"></i>
                        New Thread
                    </button>
                </div>
                
                <div class="threads-list">
                    <div 
                        v-for="thread in sortedThreads" 
                        :key="thread.id"
                        class="thread-item"
                        :class="{ active: currentThreadId === thread.id }"
                    >
                        <div @click="selectThread(thread.id)" class="thread-content">
                            <div class="thread-title">[[ thread.title ]]</div>
                            <div class="thread-meta">
                                <span class="message-count">[[ thread.id === currentThreadId ? messageCount : thread.message_count ]] messages</span>
                                <span class="thread-date">[[ formatDate(thread.updated_at) ]]</span>
                            </div>
                        </div>
                        <div class="thread-actions">
                            <button v-if="!thread.id.toString().startsWith('temp_')" @click.stop="archiveThread(thread.id)" class="action-btn archive-btn" title="Archive thread">
                                <i class="fas fa-archive"></i>
                            </button>
                            <button @click.stop="confirmDeleteThread(thread.id)" class="action-btn delete-btn" title="Delete thread">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Archived Threads Section -->
                <div v-if="hasArchivedThreads" class="archived-section">
                    <button @click="toggleArchivedSection" class="archived-header">
                        <i :class="showArchivedSection ? 'fas fa-chevron-down' : 'fas fa-chevron-right'"></i>
                        Archived Threads ([[ archivedThreads.length ]])
                    </button>
                    
                    <div v-if="showArchivedSection" class="archived-list">
                        <div 
                            v-for="thread in archivedThreads" 
                            :key="'archived-' + thread.id"
                            class="thread-item archived"
                            :class="{ active: currentThreadId === thread.id }"
                        >
                            <div @click="selectThread(thread.id)" class="thread-content">
                                <div class="thread-title">[[ thread.title ]]</div>
                                <div class="thread-meta">
                                    <span class="message-count">[[ thread.id === currentThreadId ? messageCount : thread.message_count ]] messages</span>
                                    <span class="thread-date">Archived [[ formatDate(thread.archived_at) ]]</span>
                                </div>
                            </div>
                            <div class="thread-actions">
                                <button @click.stop="archiveThread(thread.id)" class="action-btn unarchive-btn" title="Unarchive thread">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button @click.stop="confirmDeleteThread(thread.id)" class="action-btn delete-btn" title="Delete thread">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <button @click="showRoleManager = true" class="sidebar-btn">
                        <i class="fas fa-user-tag"></i>
                        Roles
                    </button>
                </div>
            </div>

            <!-- Mobile Sidebar Backdrop -->
            <div class="sidebar-backdrop" :class="{ show: sidebarOpen }" @click="sidebarOpen = false"></div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Header -->
                <div class="header">
                    <button @click="sidebarOpen = !sidebarOpen" class="sidebar-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <div v-if="currentThreadId" class="thread-toolbar">
                        <!-- Show selectors for new threads with no messages -->
                        <div v-if="shouldShowRoleSelector" class="thread-selectors">
                            <div class="selector-group">
                                <select v-model="threadSettings.model_name" @change="updateThreadSettings" class="setting-select">
                                    <option v-for="model in models" :key="model.id" :value="model.id">
                                        [[ model.name ]]
                                    </option>
                                </select>
                            </div>
                            
                            <div v-if="roles.length > 0 && shouldShowRoleSelector" class="selector-group">
                                <select v-model="threadSettings.role_id" @change="updateThreadSettings" class="setting-select">
                                    <option :value="null">Default Role</option>
                                    <option v-for="role in roles" :key="role.id" :value="role.id">
                                        [[ role.name ]]
                                    </option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Show current settings badges after first message -->
                        <div v-else class="current-settings">
                            <div class="setting-badge model-badge">
                                <i class="fas fa-brain"></i>
                                [[ threadSettings.model_name || 'No model' ]]
                            </div>
                            
                            <div v-if="threadSettings.role_id" class="setting-badge role-badge">
                                <i class="fas fa-user-tag"></i>
                                [[ currentRoleName ]]
                            </div>
                            
                            <div class="setting-badge temp-badge">
                                <i class="fas fa-thermometer-half"></i>
                                [[ threadSettings.temperature || 1.0 ]]
                            </div>
                        </div>
                        
                        <!-- Thread settings button -->
                        <button @click="showSettings = true" class="thread-settings-btn" title="Thread Settings">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>

                <!-- Messages -->
                <div class="messages-container" ref="messagesContainer">
                    <div v-if="!currentThreadId" class="welcome-message">
                        <h2>Welcome to {{.BotName}} Assistant</h2>
                        <p>Create a new thread to start chatting, or select an existing thread from the sidebar.</p>
                    </div>
                    
                    <div v-else>
                        <div 
                            v-for="message in messages" 
                            :key="message.id"
                            class="message"
                            :class="[message.role, message.message_type]"
                        >
                            <div class="message-avatar">
                                <i v-if="message.role === 'user'" class="fas fa-user"></i>
                                <i v-else-if="message.role === 'assistant'" class="fas fa-robot"></i>
                                <i v-else class="fas fa-info-circle"></i>
                            </div>
                            <div 
                                class="message-content" 
                                :class="{ 'is-complete': message.is_complete, 'is-streaming': message.isStreaming }"
                                :style="message.isStreaming && message.estimatedHeight ? { minHeight: message.estimatedHeight + 'px' } : {}"
                            >
                                <div v-if="message.message_type === 'summary'" class="summary-header">
                                    <i class="fas fa-compress-alt"></i>
                                    Conversation Summary
                                </div>
                                
                                <div v-if="message.image_data" class="message-image">
                                    <img :src="message.image_data" :alt="message.image_name" class="message-image-content">
                                </div>
                                
                                <div 
                                    class="message-text prose" 
                                    :class="{ 'streaming-text': message.isStreaming }"
                                    v-html="formatMessage(message.content)"
                                ></div>
                                <div class="message-meta">
                                    [[ formatTime(message.created_at) ]]
                                    <span v-if="!message.is_live" class="archived-badge">Archived</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div v-if="currentThreadId" class="input-container">
                    <div v-if="attachedImage" class="image-attachment-preview">
                        <div class="attached-image">
                            <img :src="attachedImage.preview" :alt="attachedImage.name" class="attachment-preview-image">
                            <div class="attachment-info">
                                <span class="attachment-name">[[ attachedImage.name ]]</span>
                                <span class="attachment-size">[[ formatFileSize(attachedImage.size) ]]</span>
                            </div>
                            <button @click="clearAttachedImage" class="clear-attachment-btn" title="Remove image">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-wrapper">
                        <button 
                            @click="selectImage"
                            class="image-attach-btn"
                            :class="{ active: !!attachedImage }"
                            title="Attach image"
                        >
                            <i class="fas fa-image"></i>
                        </button>
                        
                        <textarea
                            ref="messageInput"
                            v-model="messageInput"
                            @keydown="handleKeyDown"
                            @focus="onInputFocus"
                            @blur="onInputBlur"
                            @touchstart.passive="onInputTouch"
                            placeholder="Type your message..."
                            class="message-input"
                            :disabled="sending"
                            autocomplete="off"
                            autocorrect="off"
                            autocapitalize="sentences"
                            spellcheck="true"
                        ></textarea>
                        <button 
                            @click="streaming ? stopStreaming() : sendMessage()"
                            :disabled="!canSendMessage && !canStopStreaming"
                            class="send-button"
                            :class="{
                                'sending': sendButtonState === 'sending',
                                'streaming': sendButtonState === 'streaming',
                                'stop-button': streaming
                            }"
                            :title="streaming ? 'Stop generation' : 'Send message (Enter)'"
                        >
                            <i :class="sendButtonIcon"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div v-if="showSettings" class="modal-overlay" @click="showSettings = false">
            <div class="modal" @click.stop>
                <div class="modal-header">
                    <h3>Thread Settings</h3>
                    <button @click="showSettings = false" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="setting-group">
                        <label>Model</label>
                        <select v-model="threadSettings.model_name">
                            <option v-for="model in models" :key="model.id" :value="model.id">
                                [[ model.name ]] ([[ model.provider ]])
                            </option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label>Temperature: [[ threadSettings.temperature ]]</label>
                        <input 
                            type="range" 
                            v-model.number="threadSettings.temperature"
                            min="0" 
                            max="1" 
                            step="0.1"
                            class="slider"
                        >
                    </div>
                    
                    <div class="setting-group" v-if="shouldShowRoleSelector">
                        <label>Role ([[ roles.length ]] available)</label>
                        <select v-model="threadSettings.role_id">
                            <option :value="null">No role</option>
                            <option v-if="roles.length === 0" disabled>Loading roles...</option>
                            <option v-for="role in roles" :key="role.id" :value="role.id">
                                [[ role.name ]]
                            </option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label>Context Limit</label>
                        <input 
                            type="number" 
                            v-model.number="threadSettings.context_limit"
                            min="1000" 
                            max="8000"
                            step="500"
                        >
                    </div>
                    
                </div>
                <div class="modal-footer">
                    <button @click="saveSettings" class="save-btn">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- Role Manager Modal -->
        <div v-if="showRoleManager" class="modal-overlay" @click="showRoleManager = false">
            <div class="modal" @click.stop>
                <div class="modal-header">
                    <h3>Role Manager</h3>
                    <button @click="showRoleManager = false" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <button @click="newRole" class="new-role-btn">
                        <i class="fas fa-plus"></i>
                        New Role
                    </button>
                    
                    <div class="roles-list">
                        <div 
                            v-for="role in roles" 
                            :key="role.id"
                            class="role-item"
                        >
                            <div class="role-header">
                                <span class="role-name">[[ role.name ]]</span>
                                <div class="role-actions">
                                    <button @click="editRole(role)" class="edit-btn">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click="deleteRole(role.id)" class="delete-btn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="role-prompt">[[ role.prompt ]]</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Role Editor Modal -->
        <div v-if="showRoleEditor" class="modal-overlay" @click="showRoleEditor = false">
            <div class="modal" @click.stop>
                <div class="modal-header">
                    <h3>[[ editingRole?.id ? 'Edit Role' : 'New Role' ]]</h3>
                    <button @click="showRoleEditor = false" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="setting-group">
                        <label>Role Name</label>
                        <input 
                            type="text" 
                            v-model="editingRole.name"
                            placeholder="Enter role name"
                        >
                    </div>
                    
                    <div class="setting-group">
                        <label>System Prompt</label>
                        <textarea 
                            v-model="editingRole.prompt"
                            placeholder="Enter system prompt..."
                            rows="6"
                        ></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="saveRole" class="save-btn">
                        [[ editingRole?.id ? 'Update Role' : 'Create Role' ]]
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Dialog -->
        <div v-if="showDeleteConfirm" class="modal-overlay" @click="cancelDelete">
            <div class="modal confirm-modal" @click.stop>
                <div class="modal-header">
                    <h3>Delete Thread</h3>
                    <button @click="cancelDelete" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="warning-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <p>Are you sure you want to delete this thread? This cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button @click="cancelDelete" class="cancel-btn">Cancel</button>
                    <button @click="deleteThread" class="delete-btn">Delete Thread</button>
                </div>
            </div>
        </div>

    </div>

    <script src="/assets/js/app.js"></script>
</body>
</html>